<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Budget App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #sidebar.translate-x-0 {
            transform: translateX(0);
        }
        .active-nav {
            background-color: #4A5568; /* A darker gray for active state */
        }
        th[data-sort] {
            cursor: pointer;
            user-select: none;
        }
        th[data-sort].sort-asc::after,
        th[data-sort].sort-desc::after {
            content: '';
            display: inline-block;
            margin-left: 0.5em;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        th[data-sort].sort-asc::after {
            border-bottom: 5px solid currentColor;
        }
        th[data-sort].sort-desc::after {
            border-top: 5px solid currentColor;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
            <h2 class="text-2xl font-bold mb-6 text-center">Fast Budget</h2>
            <nav id="mainNav">
                <a href="#" onclick="showView('dashboardView', this)" class="nav-link active-nav flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                    <i data-feather="home" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="#" onclick="showView('incomeView', this)" class="nav-link flex items-center px-4 py-2 mt-2 rounded-md hover:bg-gray-700">
                     <i data-feather="trending-up" class="w-5 h-5 mr-3"></i>
                    Income
                </a>
                <a href="#" onclick="showView('expensesView', this)" class="nav-link flex items-center px-4 py-2 mt-2 rounded-md hover:bg-gray-700">
                    <i data-feather="trending-down" class="w-5 h-5 mr-3"></i>
                    Expenses
                </a>
                <a href="#" onclick="showView('subscriptionsView', this)" class="nav-link flex items-center px-4 py-2 mt-2 rounded-md hover:bg-gray-700">
                     <i data-feather="repeat" class="w-5 h-5 mr-3"></i>
                    Subscriptions
                </a>
                <a href="#" onclick="showView('budgetsView', this)" class="nav-link flex items-center px-4 py-2 mt-2 rounded-md hover:bg-gray-700">
                    <i data-feather="target" class="w-5 h-5 mr-3"></i>
                    Budgets
                </a>
                <a href="#" onclick="showView('pointsView', this)" class="nav-link flex items-center px-4 py-2 mt-2 rounded-md hover:bg-gray-700">
                    <i data-feather="star" class="w-5 h-5 mr-3"></i>
                    Points
                </a>
                <a href="#" onclick="showView('reportsView', this)" class="nav-link flex items-center px-4 py-2 mt-2 rounded-md hover:bg-gray-700">
                    <i data-feather="bar-chart-2" class="w-5 h-5 mr-3"></i>
                    Reports
                </a>
                <a href="#" onclick="showView('settingsView', this)" class="nav-link flex items-center px-4 py-2 mt-2 rounded-md hover:bg-gray-700">
                    <i data-feather="settings" class="w-5 h-5 mr-3"></i>
                    Settings
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-md p-4 flex items-center justify-between">
                 <div class="flex items-center">
                    <button id="hamburger" class="md:hidden text-gray-600 mr-4">
                        <i data-feather="menu" class="w-6 h-6"></i>
                    </button>
                    <a href="#" id="homeLink" onclick="showView('dashboardView', document.querySelector('[onclick*=\'dashboardView\']'))" class="text-gray-600 hover:text-blue-600 hidden">
                        <i data-feather="home" class="w-6 h-6"></i>
                    </a>
                </div>
                <h1 id="pageTitle" class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <div id="currentDate" class="text-sm text-gray-500"></div>
            </header>
            
            <main id="app" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6 lg:p-8">
                <!-- Dashboard View -->
                <div id="dashboardView" class="view">
                    <!-- Desktop View -->
                    <div class="hidden md:grid md:grid-cols-3 md:gap-6">
                        <div class="col-span-2 space-y-6">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-white p-4 rounded-lg shadow">
                                    <h4 class="text-gray-500">Balance</h4>
                                    <p id="desktopBalance" class="text-2xl font-bold">$0</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow">
                                    <h4 class="text-gray-500">This Month</h4>
                                    <p id="desktopThisMonth" class="text-2xl font-bold text-green-600">$0</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow">
                                    <h4 class="text-gray-500">Last Month</h4>
                                    <p id="desktopLastMonth" class="text-2xl font-bold text-red-600">$0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-xl font-semibold mb-4">Upcoming & Recent Transactions</h3>
                                <div id="desktopTransactionsList" class="max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="col-span-1 space-y-6">
                             <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-xl font-semibold mb-4">Spend by Category (This Month)</h3>
                                <div id="desktopSpendByCategory" class="space-y-4"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-xl font-semibold mb-4">Budgets</h3>
                                <div id="desktopBudgets" class="space-y-4"></div>
                            </div>
                             <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-xl font-semibold mb-4">Upcoming Birthdays</h3>
                                <ul id="upcomingBirthdays" class="list-disc list-inside space-y-2"></ul>
                            </div>
                        </div>
                    </div>
                    <!-- Mobile View -->
                    <div class="md:hidden space-y-6">
                         <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">Monthly Summary</h3>
                            <div id="mobileSummary" class="grid grid-cols-3 gap-4 text-center mb-4">
                                <div class="p-2 bg-green-100 rounded-lg">
                                    <p class="text-sm text-green-800">Income</p>
                                    <p id="summaryIncome" class="text-lg font-bold text-green-600">$0</p>
                                </div>
                                <div class="p-2 bg-red-100 rounded-lg">
                                    <p class="text-sm text-red-800">Expenses</p>
                                    <p id="summaryExpenses" class="text-lg font-bold text-red-600">$0</p>
                                </div>
                                <div class="p-2 bg-blue-100 rounded-lg">
                                    <p class="text-sm text-blue-800">Net</p>
                                    <p id="summaryBalance" class="text-lg font-bold text-blue-600">$0</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="showView('expensesView', document.querySelector('[onclick*=\'expensesView\']'))" class="flex-1 text-center py-2 bg-blue-600 text-white rounded-md">Add Expense</button>
                                <a href="https://chase.com" target="_blank" class="flex-1 text-center py-2 bg-gray-200 rounded-md">Chase</a>
                                <button onclick="showView('pointsView', document.querySelector('[onclick*=\'pointsView\']'))" class="flex-1 text-center py-2 bg-gray-200 rounded-md">Points</button>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">Spend by Category (This Month)</h3>
                            <div id="mobileSpendByCategory" class="space-y-4"></div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">Upcoming & Recent Transactions</h3>
                            <div id="mobileTransactionsList"></div>
                        </div>
                    </div>
                </div>

                <!-- Income View -->
                <div id="incomeView" class="view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-blue-800">Income Summary</h3>
                            <div id="incomeSummary" class="grid grid-cols-2 gap-4 mt-2"></div>
                        </div>
                        <h2 class="text-2xl font-bold mb-4">Manage Income</h2>
                        <form id="incomeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <input type="hidden" id="incomeId">
                            <input type="text" id="incomeName" placeholder="Name (e.g., Salary)" class="p-2 border rounded-md" required>
                            <input type="text" id="incomeSource" placeholder="Source (e.g., Employer)" class="p-2 border rounded-md" required>
                            <select id="incomeType" class="p-2 border rounded-md">
                                <option value="recurring">Recurring</option>
                                <option value="one-time">One-Time</option>
                            </select>
                            <input type="number" step="0.01" id="incomeAmount" placeholder="Amount" class="p-2 border rounded-md" required>
                            <div class="md:col-span-2">
                                <input type="date" id="incomeDate" class="p-2 border rounded-md w-full">
                            </div>
                            <button type="submit" class="md:col-span-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">Add/Update Income</button>
                        </form>
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-2">Income List</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 text-left" data-sort="name">Name</th>
                                            <th class="py-2 px-4 text-left" data-sort="source">Source</th>
                                            <th class="py-2 px-4 text-left" data-sort="type">Type</th>
                                            <th class="py-2 px-4 text-right" data-sort="amount">Amount</th>
                                            <th class="py-2 px-4 text-left" data-sort="date">Date</th>
                                            <th class="py-2 px-4 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="incomeList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expenses View -->
                <div id="expensesView" class="view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Track Expenses</h2>
                        <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="expenseId">
                            <input type="text" id="expensePayee" placeholder="Payee/Store" class="p-2 border rounded-md" required>
                            <select id="expenseCategory" class="p-2 border rounded-md"></select>
                            <select id="expenseSubcategory" class="p-2 border rounded-md"></select>
                            <select id="expensePaymentType" class="p-2 border rounded-md"></select>
                            <input type="number" step="0.01" id="expenseAmount" placeholder="Amount" class="p-2 border rounded-md" required>
                            <input type="date" id="expenseDate" class="p-2 border rounded-md" required>
                            <textarea id="expenseNotes" placeholder="Notes (optional)" class="p-2 border rounded-md md:col-span-2"></textarea>
                            <button type="submit" class="md:col-span-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add/Update Expense</button>
                        </form>
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-2">Recent Expenses</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 text-left" data-sort="payee">Payee</th>
                                            <th class="py-2 px-4 text-left" data-sort="category">Category</th>
                                            <th class="py-2 px-4 text-left" data-sort="paymentType">Payment Type</th>
                                            <th class="py-2 px-4 text-right" data-sort="amount">Amount</th>
                                            <th class="py-2 px-4 text-left" data-sort="date">Date</th>
                                            <th class="py-2 px-4 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenseList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <button id="toggleCalendarBtn" class="w-full text-left font-semibold text-xl mb-4">View Calendar</button>
                        <div id="calendarContainer" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <button id="prevMonth" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&lt;</button>
                                <h3 id="calendarHeader" class="text-xl font-semibold"></h3>
                                <button id="nextMonth" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&gt;</button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center font-semibold mb-2">
                                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                            </div>
                            <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                                <!-- Calendar days will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Subscriptions View -->
                <div id="subscriptionsView" class="view hidden">
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-blue-800">Total Monthly Subscription Cost</h3>
                            <p id="totalSubscriptionCost" class="text-3xl font-bold text-blue-600">$0</p>
                        </div>
                        <h2 class="text-2xl font-bold mb-4">Manage Subscriptions</h2>
                        <form id="subscriptionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="subscriptionId">
                            <input type="text" id="subscriptionName" placeholder="Subscription Name (e.g., Netflix)" class="p-2 border rounded-md" required>
                            <input type="number" step="0.01" id="subscriptionAmount" placeholder="Monthly Cost" class="p-2 border rounded-md" required>
                            <input type="date" id="subscriptionStartDate" class="p-2 border rounded-md" required>
                            <select id="subscriptionPaymentMethod" class="p-2 border rounded-md"></select>
                            <button type="submit" class="md:col-span-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add/Update Subscription</button>
                        </form>
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-2">Active Subscriptions</h3>
                            <div class="overflow-x-auto">
                               <table class="min-w-full bg-white">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 text-left" data-sort="name">Name</th>
                                            <th class="py-2 px-4 text-right" data-sort="amount">Amount</th>
                                            <th class="py-2 px-4 text-left" data-sort="startDate">Start Date</th>
                                            <th class="py-2 px-4 text-left" data-sort="paymentMethod">Payment Method</th>
                                            <th class="py-2 px-4 text-left" data-sort="status">Status</th>
                                            <th class="py-2 px-4 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subscriptionList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budgets View -->
                <div id="budgetsView" class="view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Budget Summary</h2>
                        <div id="budgetPaymentMethodSummary" class="mb-4 border-b pb-4"></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="p-4 bg-green-100 rounded-lg">
                                <p class="text-sm text-green-800">Recurring Income</p>
                                <p id="summaryRecurringIncome" class="text-2xl font-bold text-green-600">$0</p>
                            </div>
                            <div class="p-4 bg-red-100 rounded-lg">
                                <p class="text-sm text-red-800">Total Budgeted</p>
                                <p id="summaryTotalBudgeted" class="text-2xl font-bold text-red-600">$0</p>
                            </div>
                            <div class="p-4 rounded-lg bg-blue-100">
                                <p class="text-sm text-blue-800">Remaining</p>
                                <p id="summaryBudgetRemaining" class="text-2xl font-bold text-blue-600">$0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Set Budgets</h2>
                         <form id="budgetForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="budgetId">
                            <select id="budgetCategory" class="p-2 border rounded-md"></select>
                            <select id="budgetSubcategory" class="p-2 border rounded-md"></select>
                            <input type="number" step="0.01" id="budgetAmount" placeholder="Budgeted Amount" class="p-2 border rounded-md" required>
                            <select id="budgetPaymentMethod" class="p-2 border rounded-md"></select>
                             <select id="budgetPayType" class="p-2 border rounded-md">
                                <option value="Manual">Manual Pay</option>
                                <option value="Auto">Auto Pay</option>
                            </select>
                            <input type="number" id="budgetDueDay" placeholder="Due Day of Month" min="1" max="31" class="p-2 border rounded-md">
                            <button type="submit" class="md:col-span-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Set/Update Budget</button>
                        </form>
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-2">Current Budgets</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 text-left" data-sort="category">Category</th>
                                            <th class="py-2 px-4 text-left" data-sort="subcategory">Subcategory</th>
                                            <th class="py-2 px-4 text-left" data-sort="paymentMethod">Payment Method</th>
                                            <th class="py-2 px-4 text-left" data-sort="payType">Pay Type</th>
                                            <th class="py-2 px-4 text-right" data-sort="dueDay">Due Day</th>
                                            <th class="py-2 px-4 text-right" data-sort="amount">Amount</th>
                                            <th class="py-2 px-4 text-center">Status</th>
                                            <th class="py-2 px-4 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="budgetList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Points View -->
                <div id="pointsView" class="view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Credit Card Points</h2>
                        <form id="pointsForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="pointsId">
                            <select id="pointsCategory" class="p-2 border rounded-md"></select>
                            <select id="pointsSubcategory" class="p-2 border rounded-md"></select>
                            <select id="pointsCard" class="p-2 border rounded-md"></select>
                            <input type="number" id="pointsMultiplier" placeholder="Points (e.g., 3 for 3x)" class="p-2 border rounded-md" required>
                            <button type="submit" class="md:col-span-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Set/Update Rule</button>
                        </form>
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-2">Points Rules</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 text-left" data-sort="category">Category</th>
                                            <th class="py-2 px-4 text-left" data-sort="subcategory">Subcategory</th>
                                            <th class="py-2 px-4 text-left" data-sort="card">Card</th>
                                            <th class="py-2 px-4 text-right" data-sort="multiplier">Multiplier</th>
                                            <th class="py-2 px-4 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pointsList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports View -->
                <div id="reportsView" class="view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Monthly Reports</h2>
                        <div class="mb-4">
                            <label for="reportMonth" class="mr-2">Select Month:</label>
                            <input type="month" id="reportMonth" class="p-2 border rounded-md">
                        </div>
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-xl font-semibold mb-2 border-b pb-2">Monthly Overview</h3>
                                <div id="incomeExpenseReport"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-2 border-b pb-2">Points Summary</h3>
                                <div id="pointsReport"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-2 border-b pb-2">Budget vs. Actual</h3>
                                <div id="budgetActualReport" class="overflow-x-auto"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mt-4 mb-2 border-b pb-2">Spend by Category</h3>
                                <div id="categorySpendReport"></div>
                            </div>
                            <div>
                               <h3 class="text-xl font-semibold mt-4 mb-2 border-b pb-2">Spend by Payment Type</h3>
                               <div id="paymentTypeSpendReport"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Yearly Reports</h2>
                        <div class="mb-4">
                            <label for="reportYear" class="mr-2">Select Year:</label>
                            <input type="number" id="reportYear" class="p-2 border rounded-md w-24">
                        </div>
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-xl font-semibold mb-2 border-b pb-2">Spend by Category (Yearly)</h3>
                                <div id="yearlyCategorySpendReport" class="overflow-x-auto"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mt-4 mb-2 border-b pb-2">Spend by Subcategory (Yearly)</h3>
                                <div id="yearlySubcategorySpendReport" class="overflow-x-auto"></div>
                            </div>
                             <div>
                                <h3 class="text-xl font-semibold mt-4 mb-2 border-b pb-2">Grocery Price Tracking</h3>
                                <div class="mb-2">
                                    <label for="groceryItemSelect" class="mr-2">Select Item:</label>
                                    <select id="groceryItemSelect" class="p-2 border rounded-md"></select>
                                </div>
                                <div id="groceryPriceTrackerReport" class="overflow-x-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settingsView" class="view hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Payment Methods -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Payment Methods</h3>
                            <form id="paymentMethodForm">
                                <input type="hidden" id="paymentMethodId">
                                <input type="text" id="paymentMethodName" placeholder="Name (e.g., Chase Sapphire)" class="p-2 border rounded-md w-full mb-2" required>
                                <select id="paymentMethodType" class="p-2 border rounded-md w-full mb-2">
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Bank Account">Bank Account</option>
                                </select>
                                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add/Update Method</button>
                            </form>
                            <ul id="paymentMethodList" class="mt-4"></ul>
                        </div>
                        <!-- Expense Categories -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Expense Categories</h3>
                            <form id="categoryForm">
                                 <input type="text" id="categoryName" placeholder="Main Category Name" class="p-2 border rounded-md w-full mb-2" required>
                                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Category</button>
                            </form>
                            <div id="categoryList" class="mt-4"></div>
                        </div>
                        <!-- People & Birthdays -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">People & Birthdays</h3>
                            <form id="personForm">
                                <input type="hidden" id="personId">
                                <input type="text" id="personName" placeholder="Person's Name" class="p-2 border rounded-md w-full mb-2" required>
                                <input type="date" id="personBirthday" class="p-2 border rounded-md w-full mb-2" required>
                                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add/Update Person</button>
                            </form>
                            <ul id="peopleList" class="mt-4"></ul>
                        </div>
                        <!-- Grocery Items -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Manage Grocery Items</h3>
                            <form id="groceryItemForm">
                                <input type="text" id="newGroceryItemName" placeholder="New Item (e.g., Milk)" class="p-2 border rounded-md w-full mb-2" required>
                                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Item</button>
                            </form>
                            <ul id="groceryItemList" class="mt-4 max-h-48 overflow-y-auto"></ul>
                        </div>
                        <!-- Data Management -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Data Management</h3>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="exportButton" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300">Export Data</button>
                                <label class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition duration-300 cursor-pointer text-center">
                                    Import JSON
                                    <input type="file" id="importFile" class="hidden" accept=".json">
                                </label>
                                <label class="flex-1 px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition duration-300 cursor-pointer text-center">
                                    Import CSV
                                    <input type="file" id="importCsvFile" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Note: Importing data will overwrite all existing data in the application.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="notificationMessage"></p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">Confirm Action</h3>
            <p id="modalMessage" class="mb-6">Are you sure you want to proceed? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="modalCancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="modalConfirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Itemization Modal -->
    <div id="itemizationModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <h3 id="itemizationModalTitle" class="text-xl font-bold mb-2">Itemize Expense</h3>
            <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                <div class="p-2 bg-gray-100 rounded">
                    <p class="text-sm">Total Amount</p>
                    <p id="itemizationTotal" class="font-bold text-lg">$0.00</p>
                </div>
                <div class="p-2 bg-gray-100 rounded">
                    <p class="text-sm">Remaining</p>
                    <p id="itemizationRemaining" class="font-bold text-lg">$0.00</p>
                </div>
            </div>
            <form id="itemizationForm" class="flex gap-2 mb-4">
                <input type="hidden" id="itemizationExpenseId">
                <input type="text" id="itemName" placeholder="Item Name" class="flex-grow p-2 border rounded-md" required list="groceryDataList">
                <datalist id="groceryDataList"></datalist>
                <input type="number" step="0.01" id="itemAmount" placeholder="Amount" class="w-32 p-2 border rounded-md" required>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Add</button>
            </form>
            <div class="max-h-64 overflow-y-auto border rounded-md">
                <ul id="itemizedList" class="divide-y">
                    <!-- Items will be listed here -->
                </ul>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="itemizationDone" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Done</button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        // --- DATABASE SETUP ---
        const DB_NAME = 'HomeBudgetDB';
        const DB_VERSION = 4; // Incremented version
        let db;
        let calendarDate = new Date();

        function initDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Database error:', event.target.errorCode);
                    reject('Database error');
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('income')) {
                        db.createObjectStore('income', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('expenses')) {
                        const expenseStore = db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                        expenseStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('subscriptions')) {
                        db.createObjectStore('subscriptions', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('budgets')) {
                         db.createObjectStore('budgets', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('paymentMethods')) {
                        db.createObjectStore('paymentMethods', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains('people')) {
                        db.createObjectStore('people', { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains('groceryItems')) {
                        db.createObjectStore('groceryItems', { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains('creditCardPoints')) {
                        db.createObjectStore('creditCardPoints', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database initialized successfully.');
                    resolve(db);
                };
            });
        }

        async function seedInitialData() {
            const categories = await getAllObjects('categories');
            if (categories.length === 0) {
                const defaultCategories = [
                    { name: 'Home', subcategories: ['Mortgage/Rent', 'Utilities', 'Maintenance'] },
                    { name: 'Food', subcategories: ['Groceries', 'Restaurants', 'Coffee Shops'] },
                    { name: 'School', subcategories: ['Tuition', 'Books', 'Supplies'] },
                    { name: 'Auto', subcategories: ['Gas', 'Insurance', 'Repairs'] },
                    { name: 'Subscriptions', subcategories: [] },
                    { name: 'Entertainment', subcategories: ['Movies', 'Concerts', 'Games'] },
                    { name: 'Phone', subcategories: ['Bill'] },
                    { name: 'Internet', subcategories: ['Bill'] },
                    { name: 'Projects', subcategories: ['Home Improvement', 'DIY'] },
                    { name: 'Health', subcategories: ['Insurance', 'Doctor', 'Pharmacy'] },
                    { name: 'Shopping', subcategories: ['Clothing', 'Electronics', 'Hobbies'] },
                    { name: 'Travel', subcategories: ['Flights', 'Hotels', 'Activities'] }
                ];
                for (const cat of defaultCategories) {
                    await addObject('categories', cat);
                }
            }

            const paymentMethods = await getAllObjects('paymentMethods');
            if (paymentMethods.length === 0) {
                await addObject('paymentMethods', { name: 'Chase Sapphire', type: 'Credit Card' });
                await addObject('paymentMethods', { name: 'Main Checking', type: 'Bank Account' });
            }
        }

        // --- GENERIC DB OPERATIONS ---
        function addObject(storeName, object) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject('Error adding object:', event.target.error);
            });
        }
        
        function getObject(storeName, id) {
             return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject('Error getting object:', event.target.error);
            });
        }

        function getAllObjects(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject('Error getting objects:', event.target.error);
            });
        }

        function updateObject(storeName, object) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(object);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject('Error updating object:', event.target.error);
            });
        }

        function deleteObject(storeName, id) {
             return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject('Error deleting object:', event.target.error);
            });
        }


        // --- UI LOGIC ---
        function showView(viewId, element) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            // Show the selected view
            document.getElementById(viewId).classList.remove('hidden');

            // Update page title
            document.getElementById('pageTitle').textContent = element ? element.textContent.trim() : 'Dashboard';

            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active-nav', 'bg-blue-600');
            });
             if(element) element.classList.add('active-nav', 'bg-blue-600');

            // Show/Hide Home Link
            document.getElementById('homeLink').classList.toggle('hidden', viewId === 'dashboardView');

            // Close sidebar on mobile after navigation
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDb();
                
                await seedInitialData();
                await reloadAllData();

                // Set up forms
                setupForms();
                setupTableSorting();

                // Set up reports
                document.getElementById('reportMonth').addEventListener('change', generateReports);
                const today = new Date();
                document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                document.getElementById('reportMonth').value = `${year}-${month}`;
                document.getElementById('reportYear').value = year;
                generateReports();
                generateYearlyReports();

                document.getElementById('reportYear').addEventListener('change', generateYearlyReports);
                document.getElementById('groceryItemSelect').addEventListener('change', generateYearlyReports);

                // Setup Data Management buttons
                document.getElementById('exportButton').addEventListener('click', exportData);
                document.getElementById('importFile').addEventListener('change', importData);
                document.getElementById('importCsvFile').addEventListener('change', importCsvData);
                
                // Setup Calendar
                setupCalendarNav();
                renderExpenseCalendar(calendarDate.getFullYear(), calendarDate.getMonth());

                // Setup Hamburger Menu
                document.getElementById('hamburger').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('-translate-x-full');
                });
                
                // Setup Calendar Toggle
                document.getElementById('toggleCalendarBtn').addEventListener('click', () => {
                    const calendarContainer = document.getElementById('calendarContainer');
                    const btn = document.getElementById('toggleCalendarBtn');
                    calendarContainer.classList.toggle('hidden');
                    btn.textContent = calendarContainer.classList.contains('hidden') ? 'View Calendar' : 'Hide Calendar';
                });

            } catch (error) {
                console.error("Initialization failed:", error);
                showNotification("App failed to initialize. Check console.", true);
            }
        });
        
        async function reloadAllData() {
            await loadIncome();
            await loadExpenses();
            await loadSubscriptions();
            await loadBudgets();
            await loadPaymentMethods();
            await loadCategories();
            await loadPeople();
            await loadGroceryItems();
            await loadPoints();
            await updateDashboard();
            await generateReports();
            await generateYearlyReports();
            await renderExpenseCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            await updateBudgetSummary();
            feather.replace();
        }

        function setupForms() {
            // Income Form
            document.getElementById('incomeType').addEventListener('change', (e) => {
                const dateField = document.getElementById('incomeDate');
                if (e.target.value === 'one-time') {
                    dateField.classList.remove('hidden');
                    dateField.required = true;
                } else {
                    dateField.classList.remove('hidden'); // Always visible
                    dateField.required = true;
                }
            });

            document.getElementById('incomeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const incomeData = {
                    name: document.getElementById('incomeName').value,
                    source: document.getElementById('incomeSource').value,
                    type: document.getElementById('incomeType').value,
                    amount: parseFloat(document.getElementById('incomeAmount').value),
                    date: document.getElementById('incomeDate').value
                };
                const id = document.getElementById('incomeId').value;
                if (id) {
                    incomeData.id = parseInt(id);
                    await updateObject('income', incomeData);
                } else {
                    await addObject('income', incomeData);
                }
                e.target.reset();
                document.getElementById('incomeId').value = '';
                loadIncome();
                updateDashboard();
            });

            // Expense Form
            document.getElementById('expenseForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const expenseData = {
                    payee: document.getElementById('expensePayee').value,
                    category: document.getElementById('expenseCategory').value,
                    subcategory: document.getElementById('expenseSubcategory').value,
                    paymentType: document.getElementById('expensePaymentType').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    date: document.getElementById('expenseDate').value,
                    notes: document.getElementById('expenseNotes').value,
                    items: [] 
                };
                 const id = document.getElementById('expenseId').value;
                if (id) {
                    expenseData.id = parseInt(id);
                    const existingExpense = await getObject('expenses', expenseData.id);
                    expenseData.items = existingExpense.items || []; 
                    await updateObject('expenses', expenseData);
                } else {
                    await addObject('expenses', expenseData);
                }
                e.target.reset();
                document.getElementById('expenseId').value = '';
                loadExpenses();
                updateDashboard();
            });
            
            // Subscription Form
            document.getElementById('subscriptionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const subscriptionData = {
                    name: document.getElementById('subscriptionName').value,
                    amount: parseFloat(document.getElementById('subscriptionAmount').value),
                    startDate: document.getElementById('subscriptionStartDate').value,
                    paymentMethod: document.getElementById('subscriptionPaymentMethod').value,
                    status: 'active'
                };
                const id = document.getElementById('subscriptionId').value;
                if (id) {
                    subscriptionData.id = parseInt(id);
                    await updateObject('subscriptions', subscriptionData);
                } else {
                    await addObject('subscriptions', subscriptionData);
                }
                e.target.reset();
                document.getElementById('subscriptionId').value = '';
                loadSubscriptions();
            });

            // Budget Form
            document.getElementById('budgetForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const budgetData = {
                    category: document.getElementById('budgetCategory').value,
                    subcategory: document.getElementById('budgetSubcategory').value,
                    amount: parseFloat(document.getElementById('budgetAmount').value),
                    paymentMethod: document.getElementById('budgetPaymentMethod').value,
                    payType: document.getElementById('budgetPayType').value,
                    dueDay: parseInt(document.getElementById('budgetDueDay').value) || null
                };
                const id = document.getElementById('budgetId').value;
                if(id){
                    budgetData.id = parseInt(id);
                    const existingBudget = await getObject('budgets', budgetData.id);
                    budgetData.paidMonths = existingBudget.paidMonths || [];
                    await updateObject('budgets', budgetData);
                } else {
                    budgetData.paidMonths = [];
                    await addObject('budgets', budgetData);
                }
                e.target.reset();
                document.getElementById('budgetId').value = '';
                loadBudgets();
            });

            // Payment Method Form
            document.getElementById('paymentMethodForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const paymentMethodData = {
                    name: document.getElementById('paymentMethodName').value,
                    type: document.getElementById('paymentMethodType').value
                };
                const id = document.getElementById('paymentMethodId').value;
                if (id) {
                    paymentMethodData.id = parseInt(id);
                    await updateObject('paymentMethods', paymentMethodData);
                } else {
                    await addObject('paymentMethods', paymentMethodData);
                }
                e.target.reset();
                document.getElementById('paymentMethodId').value = '';
                loadPaymentMethods();
            });

            // Category Form
            document.getElementById('categoryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const categoryName = document.getElementById('categoryName').value;
                await addObject('categories', { name: categoryName, subcategories: [] });
                e.target.reset();
                loadCategories();
            });
            
            // Person Form
            document.getElementById('personForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const personData = {
                    name: document.getElementById('personName').value,
                    birthday: document.getElementById('personBirthday').value
                };
                const id = document.getElementById('personId').value;
                if (id) {
                    personData.id = parseInt(id);
                    await updateObject('people', personData);
                } else {
                    await addObject('people', personData);
                }
                e.target.reset();
                document.getElementById('personId').value = '';
                loadPeople();
                updateDashboard();
            });

            // Grocery Item Form
            document.getElementById('groceryItemForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemName = document.getElementById('newGroceryItemName').value;
                await addObject('groceryItems', { name: itemName });
                e.target.reset();
                loadGroceryItems();
            });

            // Points Form
            document.getElementById('pointsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const pointsData = {
                    category: document.getElementById('pointsCategory').value,
                    subcategory: document.getElementById('pointsSubcategory').value,
                    card: document.getElementById('pointsCard').value,
                    multiplier: parseFloat(document.getElementById('pointsMultiplier').value)
                };
                const id = document.getElementById('pointsId').value;
                if (id) {
                    pointsData.id = parseInt(id);
                    await updateObject('creditCardPoints', pointsData);
                } else {
                    await addObject('creditCardPoints', pointsData);
                }
                e.target.reset();
                document.getElementById('pointsId').value = '';
                loadPoints();
            });
        }
        
        async function loadIncome() {
            const incomes = await getAllObjects('income');
            const list = document.getElementById('incomeList');
            const summaryEl = document.getElementById('incomeSummary');
            list.innerHTML = '';
            
            let recurringTotal = 0;
            let oneTimeTotal = 0;
            const sourceTotals = {};

            incomes.forEach(income => {
                if (income.type === 'recurring') {
                    recurringTotal += income.amount;
                } else {
                    oneTimeTotal += income.amount;
                }
                sourceTotals[income.source] = (sourceTotals[income.source] || 0) + income.amount;

                const row = list.insertRow();
                row.innerHTML = `
                    <td class="border px-4 py-2">${income.name}</td>
                    <td class="border px-4 py-2">${income.source}</td>
                    <td class="border px-4 py-2">${income.type}</td>
                    <td class="border px-4 py-2 text-right">${formatCurrency(income.amount)}</td>
                    <td class="border px-4 py-2">${income.date || 'N/A'}</td>
                    <td class="border px-4 py-2 text-center">
                        <button onclick="editIncome(${income.id})" class="text-blue-500 hover:underline">Edit</button>
                        <button onclick="deleteIncome(${income.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                    </td>
                `;
            });

            summaryEl.innerHTML = `
                <div><p class="font-semibold">Recurring Total:</p> <p class="text-lg">${formatCurrency(recurringTotal)}</p></div>
                <div><p class="font-semibold">One-Time Total:</p> <p class="text-lg">${formatCurrency(oneTimeTotal)}</p></div>
            `;
            for(const source in sourceTotals) {
                summaryEl.innerHTML += `<div><p class="font-semibold">${source}:</p> <p class="text-lg">${formatCurrency(sourceTotals[source])}</p></div>`;
            }

            await updateBudgetSummary();
        }

        async function editIncome(id) {
            const transaction = db.transaction(['income'], 'readonly');
            const store = transaction.objectStore('income');
            const request = store.get(id);
            request.onsuccess = () => {
                const income = request.result;
                document.getElementById('incomeId').value = income.id;
                document.getElementById('incomeName').value = income.name;
                document.getElementById('incomeSource').value = income.source;
                document.getElementById('incomeType').value = income.type;
                document.getElementById('incomeAmount').value = income.amount;
                document.getElementById('incomeDate').value = income.date;
            };
        }

        async function deleteIncome(id) {
            showConfirmation('Delete Income', 'Are you sure you want to delete this income source?', async () => {
                await deleteObject('income', id);
                loadIncome();
                updateDashboard();
                showNotification('Income source deleted.');
            });
        }
        
        async function loadExpenses() {
            const expenses = await getAllObjects('expenses');
            const list = document.getElementById('expenseList');
            list.innerHTML = '';
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const row = list.insertRow();
                
                const hasItems = expense.items && expense.items.length > 0;
                const itemizeButtonText = hasItems ? 'View Items' : 'Itemize';
                const itemizeButtonClass = hasItems ? 'text-green-500' : 'text-blue-500';

                let actionsHTML = `
                    <button onclick="openItemizationModal(${expense.id})" class="${itemizeButtonClass} hover:underline">${itemizeButtonText}</button>
                    <button onclick="editExpense(${expense.id})" class="text-blue-500 hover:underline ml-2">Edit</button>
                    <button onclick="deleteExpense(${expense.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                `;
                
                row.innerHTML = `
                    <td class="border px-4 py-2">${expense.payee}</td>
                    <td class="border px-4 py-2">${expense.category} / ${expense.subcategory}</td>
                    <td class="border px-4 py-2">${expense.paymentType}</td>
                    <td class="border px-4 py-2 text-right">${formatCurrency(expense.amount)}</td>
                    <td class="border px-4 py-2">${expense.date}</td>
                    <td class="border px-4 py-2 text-center">${actionsHTML}</td>
                `;
            });
            await renderExpenseCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
        }

        async function editExpense(id) {
            const transaction = db.transaction(['expenses'], 'readonly');
            const store = transaction.objectStore('expenses');
            const request = store.get(id);
            request.onsuccess = () => {
                const expense = request.result;
                document.getElementById('expenseId').value = expense.id;
                document.getElementById('expensePayee').value = expense.payee;
                document.getElementById('expenseCategory').value = expense.category;
                handleCategoryChangeForEdit(expense.category, expense.subcategory);
                document.getElementById('expensePaymentType').value = expense.paymentType;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseNotes').value = expense.notes || '';
            };
        }

        async function deleteExpense(id) {
            showConfirmation('Delete Expense', 'Are you sure you want to delete this expense?', async () => {
                await deleteObject('expenses', id);
                loadExpenses();
                updateDashboard();
                showNotification('Expense deleted.');
            });
        }

        async function loadSubscriptions() {
            const subscriptions = await getAllObjects('subscriptions');
            const list = document.getElementById('subscriptionList');
            list.innerHTML = '';
            
            const activeSubscriptions = subscriptions.filter(s => s.status === 'active');
            const totalCost = activeSubscriptions.reduce((sum, s) => sum + s.amount, 0);
            document.getElementById('totalSubscriptionCost').textContent = formatCurrency(totalCost);

            subscriptions.forEach(sub => {
                const row = list.insertRow();
                row.innerHTML = `
                    <td class="border px-4 py-2">${sub.name}</td>
                    <td class="border px-4 py-2 text-right">${formatCurrency(sub.amount)}</td>
                    <td class="border px-4 py-2">${sub.startDate}</td>
                    <td class="border px-4 py-2">${sub.paymentMethod || 'N/A'}</td>
                    <td class="border px-4 py-2">${sub.status}</td>
                    <td class="border px-4 py-2 text-center">
                         <button onclick="toggleSubscriptionStatus(${sub.id}, '${sub.status}')" class="text-yellow-500 hover:underline">${sub.status === 'active' ? 'Cancel' : 'Reactivate'}</button>
                        <button onclick="editSubscription(${sub.id})" class="text-blue-500 hover:underline ml-2">Edit</button>
                        <button onclick="deleteSubscription(${sub.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                    </td>
                `;
            });
            await renderExpenseCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            await updateBudgetSummary();
        }
        
        async function editSubscription(id) {
             const transaction = db.transaction(['subscriptions'], 'readonly');
            const store = transaction.objectStore('subscriptions');
            const request = store.get(id);
            request.onsuccess = () => {
                const sub = request.result;
                document.getElementById('subscriptionId').value = sub.id;
                document.getElementById('subscriptionName').value = sub.name;
                document.getElementById('subscriptionAmount').value = sub.amount;
                document.getElementById('subscriptionStartDate').value = sub.startDate;
                document.getElementById('subscriptionPaymentMethod').value = sub.paymentMethod;
            };
        }
        
        async function deleteSubscription(id) {
            showConfirmation('Delete Subscription', 'Are you sure?', async () => {
                await deleteObject('subscriptions', id);
                loadSubscriptions();
                showNotification('Subscription deleted.');
            });
        }
        
        async function toggleSubscriptionStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'cancelled' : 'active';
            const transaction = db.transaction(['subscriptions'], 'readwrite');
            const store = transaction.objectStore('subscriptions');
            const request = store.get(id);
            request.onsuccess = () => {
                const sub = request.result;
                sub.status = newStatus;
                store.put(sub);
                loadSubscriptions();
                showNotification(`Subscription status changed to ${newStatus}.`);
            };
        }

        async function loadBudgets() {
            const budgets = await getAllObjects('budgets');
            const subscriptions = await getAllObjects('subscriptions');
            const list = document.getElementById('budgetList');
            list.innerHTML = '';
            
            const today = new Date();
            const currentMonthStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

            // Render user-defined budgets
            budgets.forEach(budget => {
                const isPaidThisMonth = budget.paidMonths && budget.paidMonths.includes(currentMonthStr);
                const row = list.insertRow();
                if(isPaidThisMonth){
                    row.className = 'bg-green-50 text-gray-500 line-through';
                }

                let statusHTML;
                if(isPaidThisMonth){
                    statusHTML = `<button onclick="toggleBudgetPaidStatus(${budget.id})" class="text-sm text-green-700 font-semibold flex items-center justify-center w-full">
                                    <i data-feather="check-circle" class="w-4 h-4 mr-1"></i> Paid
                                 </button>`;
                } else {
                    statusHTML = `<button onclick="toggleBudgetPaidStatus(${budget.id})" class="px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded-md hover:bg-gray-300">Mark Paid</button>`;
                }

                row.innerHTML = `
                    <td class="border px-4 py-2">${budget.category}</td>
                    <td class="border px-4 py-2">${budget.subcategory}</td>
                    <td class="border px-4 py-2">${budget.paymentMethod || 'Any'}</td>
                    <td class="border px-4 py-2">${budget.payType || 'Manual'}</td>
                    <td class="border px-4 py-2 text-right">${budget.dueDay || 'N/A'}</td>
                    <td class="border px-4 py-2 text-right">${formatCurrency(budget.amount)}</td>
                    <td class="border px-4 py-2 text-center">${statusHTML}</td>
                    <td class="border px-4 py-2 text-center">
                        <button onclick="editBudget(${budget.id})" class="text-blue-500 hover:underline">Edit</button>
                        <button onclick="deleteBudget(${budget.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                    </td>
                `;
            });

            // Render subscriptions as a line item
            const activeSubscriptions = subscriptions.filter(s => s.status === 'active');
            const totalSubscriptionCost = activeSubscriptions.reduce((sum, s) => sum + s.amount, 0);

            if (totalSubscriptionCost > 0) {
                const row = list.insertRow();
                row.className = 'bg-blue-50 text-gray-600';
                row.innerHTML = `
                    <td class="border px-4 py-2 font-semibold">Subscriptions</td>
                    <td class="border px-4 py-2">Recurring</td>
                    <td class="border px-4 py-2">Various</td>
                    <td class="border px-4 py-2">Auto</td>
                    <td class="border px-4 py-2 text-right">Varies</td>
                    <td class="border px-4 py-2 text-right">${formatCurrency(totalSubscriptionCost)}</td>
                    <td class="border px-4 py-2 text-center text-sm font-semibold text-green-700">Paid (Auto)</td>
                    <td class="border px-4 py-2 text-center text-sm text-gray-500">Auto</td>
                `;
            }
            await updateBudgetSummary();
            feather.replace();
        }
        
        async function editBudget(id) {
            const transaction = db.transaction(['budgets'], 'readonly');
            const store = transaction.objectStore('budgets');
            const request = store.get(id);
            request.onsuccess = () => {
                const budget = request.result;
                document.getElementById('budgetId').value = budget.id;
                document.getElementById('budgetCategory').value = budget.category;
                handleCategoryChangeForEdit(budget.category, budget.subcategory, 'budgetSubcategory');
                document.getElementById('budgetAmount').value = budget.amount;
                document.getElementById('budgetPaymentMethod').value = budget.paymentMethod;
                document.getElementById('budgetPayType').value = budget.payType;
                document.getElementById('budgetDueDay').value = budget.dueDay;
            };
        }

        async function deleteBudget(id) {
            showConfirmation('Delete Budget', 'Are you sure?', async () => {
                await deleteObject('budgets', id);
                loadBudgets();
                showNotification('Budget deleted.');
            });
        }
        
        async function toggleBudgetPaidStatus(id) {
            const budget = await getObject('budgets', id);
            if (!budget) return;

            const today = new Date();
            const currentMonthStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

            if (!budget.paidMonths) {
                budget.paidMonths = [];
            }
            
            const paidIndex = budget.paidMonths.indexOf(currentMonthStr);

            if (paidIndex > -1) {
                // It's paid, so un-pay it
                budget.paidMonths.splice(paidIndex, 1);
                showNotification('Status updated to unpaid.');
            } else {
                // It's not paid, so pay it
                budget.paidMonths.push(currentMonthStr);
                showNotification('Marked as paid for this month.');
            }

            await updateObject('budgets', budget);
            await loadBudgets(); // Refresh the view
        }
        
        async function loadPaymentMethods() {
            const methods = await getAllObjects('paymentMethods');
            const list = document.getElementById('paymentMethodList');
            const selects = [
                document.getElementById('expensePaymentType'),
                document.getElementById('budgetPaymentMethod'),
                document.getElementById('subscriptionPaymentMethod'),
                document.getElementById('pointsCard')
            ];
            list.innerHTML = '';
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Method</option>';
            });

            methods.forEach(method => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 border-b';
                 li.innerHTML = `
                    <span class="flex items-center">
                        <i class="h-5 w-5 mr-2 text-gray-500" data-feather="${method.type === 'Credit Card' ? 'credit-card' : 'briefcase'}"></i>
                        ${method.name} (${method.type})
                    </span>
                    <div>
                        <button onclick="editPaymentMethod(${method.id})" class="text-blue-500 hover:underline">Edit</button>
                        <button onclick="deletePaymentMethod(${method.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                    </div>
                `;
                list.appendChild(li);

                const option = document.createElement('option');
                option.value = method.name;
                option.textContent = method.name;
                selects.forEach(select => {
                    if (select.id === 'pointsCard' && method.type !== 'Credit Card') return;
                    select.appendChild(option.cloneNode(true))
                });
            });
             feather.replace();
        }

        async function editPaymentMethod(id) {
            const transaction = db.transaction(['paymentMethods'], 'readonly');
            const store = transaction.objectStore('paymentMethods');
            const request = store.get(id);
            request.onsuccess = () => {
                const method = request.result;
                document.getElementById('paymentMethodId').value = method.id;
                document.getElementById('paymentMethodName').value = method.name;
                document.getElementById('paymentMethodType').value = method.type;
            };
        }

        async function deletePaymentMethod(id) {
            showConfirmation('Delete Payment Method', 'Are you sure?', async () => {
                await deleteObject('paymentMethods', id);
                loadPaymentMethods();
                showNotification('Payment method deleted.');
            });
        }

        async function loadCategories() {
            const categories = await getAllObjects('categories');
            const list = document.getElementById('categoryList');
            const selects = [
                document.getElementById('expenseCategory'),
                document.getElementById('budgetCategory'),
                document.getElementById('pointsCategory')
            ];
            
            list.innerHTML = '';
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Category</option>';
            });
            
            // Default categories
            const defaultCategories = {
                'Home': 'home', 'Food': 'shopping-cart', 'School': 'book-open', 'Auto': 'truck', 
                'Subscriptions': 'repeat', 'Entertainment': 'film', 'Phone': 'smartphone', 
                'Internet': 'wifi', 'Projects': 'tool', 'Health': 'heart', 'Shopping': 'tag', 'Travel': 'map-pin'
            };
            categories.forEach(cat => {
                 const icon = defaultCategories[cat.name] || 'folder';
                const div = document.createElement('div');
                div.className = 'p-2 border-b';

                let subcategoryHTML = cat.subcategories.map(sub => `
                    <li class="flex items-center justify-between">
                        <span class="subcategory-name">- ${sub}</span>
                        <div>
                            <button onclick="startEditSubcategory(this, ${cat.id}, '${sub}')" class="text-blue-500 text-xs p-1">edit</button>
                            <button onclick="deleteSubcategory(${cat.id}, '${sub}')" class="text-red-500 text-xs p-1">x</button>
                        </div>
                    </li>`).join('');

                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold flex items-center">
                            <i class="h-5 w-5 mr-2 text-gray-500" data-feather="${icon}"></i>
                            <span class="category-name">${cat.name}</span>
                             <button onclick="startEditCategory(this, ${cat.id})" class="text-blue-500 hover:underline ml-2 text-xs p-1">edit</button>
                        </span>
                        <button onclick="deleteCategory(${cat.id})" class="text-red-500 hover:underline">Delete</button>
                    </div>
                    <form class="subcategoryForm mt-2" data-category-id="${cat.id}">
                        <input type="text" placeholder="New Subcategory" class="p-1 border rounded-md text-sm" required>
                        <button type="submit" class="px-2 py-1 bg-green-500 text-white rounded-md text-sm">Add</button>
                    </form>
                    <ul class="ml-4 mt-2">
                        ${subcategoryHTML}
                    </ul>
                `;
                list.appendChild(div);

                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                selects.forEach(select => select.appendChild(option.cloneNode(true)));
            });
             feather.replace();

            document.querySelectorAll('.subcategoryForm').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const categoryId = parseInt(e.target.dataset.categoryId);
                    const subcategoryName = e.target.querySelector('input').value;
                    
                    const transaction = db.transaction(['categories'], 'readwrite');
                    const store = transaction.objectStore('categories');
                    const request = store.get(categoryId);
                    request.onsuccess = () => {
                        const category = request.result;
                        if (category && !category.subcategories.includes(subcategoryName)) {
                            category.subcategories.push(subcategoryName);
                            store.put(category);
                            e.target.querySelector('input').value = '';
                            loadCategories();
                        }
                    };
                });
            });
        }
        
        async function deleteCategory(id) {
            showConfirmation('Delete Category', 'This will delete the category and all its subcategories. Are you sure?', async () => {
                await deleteObject('categories', id);
                loadCategories();
                showNotification('Category deleted.');
            });
        }

        async function deleteSubcategory(categoryId, subcategoryName) {
            showConfirmation('Delete Subcategory', 'Are you sure?', async () => {
                const transaction = db.transaction(['categories'], 'readwrite');
                const store = transaction.objectStore('categories');
                const request = store.get(categoryId);
                request.onsuccess = () => {
                    const category = request.result;
                    if (category) {
                        category.subcategories = category.subcategories.filter(s => s !== subcategoryName);
                        store.put(category);
                        loadCategories();
                        showNotification('Subcategory deleted.');
                    }
                };
            });
        }

        async function loadPeople() {
            const people = await getAllObjects('people');
            const list = document.getElementById('peopleList');
            list.innerHTML = '';
            people.forEach(person => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 border-b';
                li.innerHTML = `
                    <span>${person.name} (Birthday: ${person.birthday})</span>
                    <div>
                        <button onclick="editPerson(${person.id})" class="text-blue-500 hover:underline">Edit</button>
                        <button onclick="deletePerson(${person.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }
        
        async function editPerson(id) {
            const transaction = db.transaction(['people'], 'readonly');
            const store = transaction.objectStore('people');
            const request = store.get(id);
            request.onsuccess = () => {
                const person = request.result;
                document.getElementById('personId').value = person.id;
                document.getElementById('personName').value = person.name;
                document.getElementById('personBirthday').value = person.birthday;
            };
        }

        async function deletePerson(id) {
            showConfirmation('Delete Person', 'Are you sure?', async () => {
                await deleteObject('people', id);
                loadPeople();
                updateDashboard();
                showNotification('Person deleted.');
            });
        }

        // --- DASHBOARD & REPORTS ---
        async function updateDashboard() {
            const incomes = await getAllObjects('income');
            const expenses = await getAllObjects('expenses');
            const people = await getAllObjects('people');
            const budgets = await getAllObjects('budgets');
            const subscriptions = await getAllObjects('subscriptions');

            updateDashboardSummaryCards(incomes, expenses);
            renderDashboardTransactions(budgets, subscriptions, expenses);
            updateDashboardDesktopBudgets(budgets, subscriptions, expenses);
            updateDashboardBirthdays(people);
            updateDashboardSpendByCategory(expenses);
        }
        
        async function renderDashboardTransactions(budgets, subscriptions, expenses) {
            const mobileList = document.getElementById('mobileTransactionsList');
            const desktopList = document.getElementById('desktopTransactionsList');
            mobileList.innerHTML = '';
            desktopList.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const sevenDaysLater = new Date(today);
            sevenDaysLater.setDate(today.getDate() + 7);
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            let transactions = [];

            // Upcoming Budgets
            budgets.forEach(b => {
                if (b.dueDay) {
                    const dueDate = new Date(today.getFullYear(), today.getMonth(), b.dueDay);
                    if (dueDate >= today && dueDate <= sevenDaysLater) {
                        transactions.push({
                            date: dueDate.toISOString().slice(0, 10),
                            description: `${b.category} / ${b.subcategory}`,
                            amount: b.amount,
                            type: 'upcoming'
                        });
                    }
                }
            });

            // Upcoming Subscriptions
            const activeSubs = subscriptions.filter(s => s.status === 'active');
            activeSubs.forEach(s => {
                const subDate = new Date(s.startDate);
                const subDay = subDate.getDate();
                
                let nextDueDate = new Date(today.getFullYear(), today.getMonth(), subDay);
                if(nextDueDate < today) {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                }

                if (nextDueDate >= today && nextDueDate <= sevenDaysLater) {
                     transactions.push({
                        date: nextDueDate.toISOString().slice(0, 10),
                        description: s.name,
                        amount: s.amount,
                        type: 'upcoming'
                    });
                }
            });


            // Recent Expenses
            expenses.forEach(e => {
                const expenseDate = new Date(e.date + 'T00:00:00');
                if (expenseDate <= today && expenseDate >= sevenDaysAgo) {
                    transactions.push({
                        date: e.date,
                        description: e.payee,
                        amount: e.amount,
                        type: 'recent'
                    });
                }
            });
            
            // Sort transactions by date
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Group transactions by date
            const grouped = transactions.reduce((acc, t) => {
                (acc[t.date] = acc[t.date] || []).push(t);
                return acc;
            }, {});
            
            let html = '';
            if (Object.keys(grouped).length === 0) {
                html = '<p class="text-gray-500">No transactions in the next or last 7 days.</p>';
            } else {
                 for (const dateStr in grouped) {
                    const date = new Date(dateStr + 'T00:00:00');
                    const isToday = date.toDateString() === today.toDateString();
                    const dateHeader = isToday ? 'Today' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    html += `<div class="mt-4"><p class="font-bold text-gray-700">${dateHeader}</p><ul class="mt-1 space-y-2">`;
                    
                    grouped[dateStr].forEach(t => {
                        const amountClass = t.type === 'upcoming' ? 'text-yellow-600' : 'text-red-600';
                         html += `
                            <li class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                                <span>${t.description}</span>
                                <span class="font-semibold ${amountClass}">${formatCurrency(t.amount)}</span>
                            </li>
                        `;
                    });

                    html += '</ul></div>';
                 }
            }
            
            mobileList.innerHTML = html;
            desktopList.innerHTML = html;
        }


        function updateDashboardSummaryCards(incomes, expenses) {
            const totalIncome = incomes.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = expenses.reduce((sum, item) => sum + item.amount, 0);
            const balance = totalIncome - totalExpenses;
            
            const today = new Date();
            const currentMonthStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            const lastMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastMonthStr = `${lastMonthDate.getFullYear()}-${(lastMonthDate.getMonth() + 1).toString().padStart(2, '0')}`;
            
            const thisMonthIncome = incomes.filter(i => (i.type === 'recurring') || (i.date && i.date.startsWith(currentMonthStr))).reduce((sum, i) => sum + i.amount, 0);
            const thisMonthExpenses = expenses.filter(e => e.date.startsWith(currentMonthStr)).reduce((sum, e) => sum + e.amount, 0);
            const thisMonthNet = thisMonthIncome - thisMonthExpenses;
            
            const lastMonthIncomeEntries = incomes.filter(i => (i.type === 'recurring') || (i.date && i.date.startsWith(lastMonthStr)));
            const lastMonthExpenseEntries = expenses.filter(e => e.date.startsWith(lastMonthStr));
            let lastMonthNet = 0;
            if (lastMonthIncomeEntries.length > 0 || lastMonthExpenseEntries.length > 0) {
                 const lastMonthIncome = lastMonthIncomeEntries.reduce((sum, i) => sum + i.amount, 0);
                 const lastMonthExpenses = lastMonthExpenseEntries.reduce((sum, e) => sum + e.amount, 0);
                 lastMonthNet = lastMonthIncome - lastMonthExpenses;
            }

            // Mobile
            document.getElementById('summaryIncome').textContent = formatCurrency(thisMonthIncome);
            document.getElementById('summaryExpenses').textContent = formatCurrency(thisMonthExpenses);
            document.getElementById('summaryBalance').textContent = formatCurrency(thisMonthNet);

            // Desktop
            document.getElementById('desktopBalance').textContent = formatCurrency(balance);
            document.getElementById('desktopThisMonth').textContent = formatCurrency(thisMonthNet);
            document.getElementById('desktopLastMonth').textContent = formatCurrency(lastMonthNet);
            document.getElementById('desktopThisMonth').className = `text-2xl font-bold ${thisMonthNet >= 0 ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('desktopLastMonth').className = `text-2xl font-bold ${lastMonthNet >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }
        
        async function updateDashboardSpendByCategory(allExpenses) {
            const today = new Date();
            const currentMonthStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            const monthlyExpenses = allExpenses.filter(e => e.date.startsWith(currentMonthStr));
            
            const spendByCategory = monthlyExpenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});

            const totalSpend = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            const sortedCategories = Object.entries(spendByCategory).sort(([,a],[,b]) => b-a);

            const renderContainer = (containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                if (sortedCategories.length > 0) {
                    sortedCategories.forEach(([category, amount]) => {
                        const percentage = totalSpend > 0 ? (amount / totalSpend) * 100 : 0;
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <div class="flex justify-between mb-1">
                                <span class="font-semibold text-sm">${category}</span>
                                <span class="text-sm">${formatCurrency(amount)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500">No spending this month.</p>';
                }
            };
            
            renderContainer('desktopSpendByCategory');
            renderContainer('mobileSpendByCategory');
        }

        function updateDashboardDesktopBudgets(budgets, subscriptions, expenses) {
            const desktopBudgetsEl = document.getElementById('desktopBudgets');
            if (!desktopBudgetsEl) return;
            desktopBudgetsEl.innerHTML = '';

            const today = new Date();
            const currentMonthStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            const monthlyExpenses = expenses.filter(e => e.date.startsWith(currentMonthStr));
            const allActiveSubs = subscriptions.filter(s => s.status === 'active');
            
            budgets.forEach(budget => {
                const actualSpend = monthlyExpenses.filter(e => e.category === budget.category && e.subcategory === budget.subcategory).reduce((sum, e) => sum + e.amount, 0);
                const percentage = budget.amount > 0 ? (actualSpend / budget.amount) * 100 : 0;
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-semibold">${budget.category} / ${budget.subcategory}</span>
                        <span>${formatCurrency(actualSpend)} / ${formatCurrency(budget.amount)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-green-600 h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                `;
                desktopBudgetsEl.appendChild(div);
            });

            const subCost = allActiveSubs.reduce((sum, s) => sum + s.amount, 0);
             if (subCost > 0) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-semibold">Subscriptions</span>
                        <span>${formatCurrency(subCost)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>
                    </div>
                `;
                desktopBudgetsEl.appendChild(div);
            }
        }
        
        function updateDashboardBirthdays(people) {
             const upcomingBirthdaysList = document.getElementById('upcomingBirthdays');
            if (!upcomingBirthdaysList) return;
            upcomingBirthdaysList.innerHTML = '';
            const today = new Date();
            const upcoming = people.filter(p => {
                if (!p.birthday) return false;
                const birthday = new Date(p.birthday + 'T00:00:00');
                birthday.setFullYear(today.getFullYear());
                const diff = birthday.getTime() - today.getTime();
                return diff > 0 && diff < (30 * 24 * 60 * 60 * 1000); // within 30 days
            }).sort((a,b) => new Date(a.birthday) - new Date(b.birthday));

            if (upcoming.length > 0) {
                upcoming.forEach(p => {
                    const li = document.createElement('li');
                    const bday = new Date(p.birthday + 'T00:00:00');
                    li.textContent = `${p.name} on ${bday.toLocaleDateString(undefined, {month: 'long', day: 'numeric'})}`;
                    upcomingBirthdaysList.appendChild(li);
                });
            } else {
                upcomingBirthdaysList.innerHTML = '<li>No upcoming birthdays in the next 30 days.</li>';
            }
        }

        async function updateBudgetSummary() {
            const allBudgets = await getAllObjects('budgets');
            const allIncome = await getAllObjects('income');
            const allSubscriptions = await getAllObjects('subscriptions');

            const userBudgeted = allBudgets.reduce((sum, b) => sum + b.amount, 0);
            const activeSubscriptions = allSubscriptions.filter(s => s.status === 'active');
            const subscriptionCosts = activeSubscriptions.reduce((sum, s) => sum + s.amount, 0);
            
            const totalBudgeted = userBudgeted + subscriptionCosts;

            const recurringIncome = allIncome
                .filter(i => i.type === 'recurring')
                .reduce((sum, i) => sum + i.amount, 0);
            
            const remaining = recurringIncome - totalBudgeted;

            document.getElementById('summaryRecurringIncome').textContent = formatCurrency(recurringIncome);
            document.getElementById('summaryTotalBudgeted').textContent = formatCurrency(totalBudgeted);
            document.getElementById('summaryBudgetRemaining').textContent = formatCurrency(remaining);
            
            const remainingEl = document.getElementById('summaryBudgetRemaining');
            const remainingContainer = remainingEl.parentElement;
            
            remainingContainer.className = remainingContainer.className.replace(/bg-blue-100|bg-red-100/g, '');
            remainingEl.className = remainingEl.className.replace(/text-blue-600|text-red-600/g, '');
            remainingContainer.parentElement.querySelector('.text-sm').className = remainingContainer.parentElement.querySelector('.text-sm').className.replace(/text-blue-800|text-red-800/g, '');


            if (remaining >= 0) {
                remainingContainer.classList.add('bg-blue-100');
                remainingEl.classList.add('text-blue-600');
                 remainingContainer.parentElement.querySelector('.text-sm').classList.add('text-blue-800');
            } else {
                remainingContainer.classList.add('bg-red-100');
                remainingEl.classList.add('text-red-600');
                remainingContainer.parentElement.querySelector('.text-sm').classList.add('text-red-800');
            }

            // Payment Method Summary
            const paymentTotals = {};
            allBudgets.forEach(b => {
                const method = b.paymentMethod || 'Unassigned';
                paymentTotals[method] = (paymentTotals[method] || 0) + b.amount;
            });
            activeSubscriptions.forEach(s => {
                const method = s.paymentMethod || 'Unassigned';
                paymentTotals[method] = (paymentTotals[method] || 0) + s.amount;
            });

            const summaryEl = document.getElementById('budgetPaymentMethodSummary');
            summaryEl.innerHTML = '<h3 class="text-xl font-semibold mb-2">Budgeted by Payment Method</h3>';
            const list = document.createElement('div');
            list.className = 'grid grid-cols-2 md:grid-cols-4 gap-2 text-sm';
            for (const method in paymentTotals) {
                const item = document.createElement('div');
                item.className = 'bg-gray-100 p-2 rounded-md';
                item.innerHTML = `<p class="font-semibold">${method}</p><p>${formatCurrency(paymentTotals[method])}</p>`;
                list.appendChild(item);
            }
            summaryEl.appendChild(list);
        }

        async function generateReports() {
            const reportMonthValue = document.getElementById('reportMonth').value;
            const incomeExpenseReportEl = document.getElementById('incomeExpenseReport');
            const budgetActualReportEl = document.getElementById('budgetActualReport');
            const categorySpendReportEl = document.getElementById('categorySpendReport');
            const paymentTypeSpendReportEl = document.getElementById('paymentTypeSpendReport');
            const pointsReportEl = document.getElementById('pointsReport');

            if (!reportMonthValue) {
                incomeExpenseReportEl.innerHTML = '<p>Select a month to view reports.</p>';
                budgetActualReportEl.innerHTML = '';
                categorySpendReportEl.innerHTML = '';
                paymentTypeSpendReportEl.innerHTML = '';
                pointsReportEl.innerHTML = '';
                return;
            }

            const allExpenses = await getAllObjects('expenses');
            const allBudgets = await getAllObjects('budgets');
            const allSubscriptions = await getAllObjects('subscriptions');
            const allIncome = await getAllObjects('income');
            const allPointsRules = await getAllObjects('creditCardPoints');

            // --- Calculations ---
            const monthlyExpenses = allExpenses.filter(expense => expense.date.startsWith(reportMonthValue));
            const activeSubscriptions = allSubscriptions.filter(s => s.status === 'active');
            const totalSubscriptionCost = activeSubscriptions.reduce((sum, s) => sum + s.amount, 0);
            
            const monthlyIncome = allIncome.filter(i => {
                if (i.type === 'recurring') return true;
                if (i.type === 'one-time' && i.date && i.date.startsWith(reportMonthValue)) return true;
                return false;
            });
            const totalMonthlyIncome = monthlyIncome.reduce((sum, i) => sum + i.amount, 0);

            let totalMonthlyExpenses = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            let netBalance = 0;
            
            const selectedDate = new Date(reportMonthValue + '-02T00:00:00'); // Use day 2 to avoid timezone issues
            const today = new Date();
            today.setHours(0,0,0,0);

            // If viewing a future month, use budgeted amounts instead of actuals
            if (selectedDate > today) {
                const totalBudgeted = allBudgets.reduce((sum, b) => sum + b.amount, 0);
                totalMonthlyExpenses = totalBudgeted + totalSubscriptionCost;
            } else {
                totalMonthlyExpenses += totalSubscriptionCost;
            }
            
            netBalance = totalMonthlyIncome - totalMonthlyExpenses;

            // --- 1. Income vs. Expense Report ---
            incomeExpenseReportEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-green-100 rounded-lg">
                        <p class="text-sm text-green-800">Total Income</p>
                        <p class="text-2xl font-bold text-green-600">${formatCurrency(totalMonthlyIncome)}</p>
                    </div>
                    <div class="p-4 bg-red-100 rounded-lg">
                        <p class="text-sm text-red-800">Total Expenses</p>
                        <p class="text-2xl font-bold text-red-600">${formatCurrency(totalMonthlyExpenses)}</p>
                    </div>
                    <div class="p-4 rounded-lg ${netBalance >= 0 ? 'bg-blue-100' : 'bg-orange-100'}">
                        <p class="text-sm ${netBalance >= 0 ? 'text-blue-800' : 'text-orange-800'}">Net Balance</p>
                        <p class="text-2xl font-bold ${netBalance >= 0 ? 'text-blue-600' : 'text-orange-600'}">${formatCurrency(netBalance)}</p>
                    </div>
                </div>
            `;
            
            // --- 2. Budget vs. Actual Report ---
            budgetActualReportEl.innerHTML = ''; 
            const totalBudgeted = allBudgets.reduce((sum, b) => sum + b.amount, 0) + totalSubscriptionCost;
            
            const reportData = allBudgets.map(budget => {
                const actualSpend = monthlyExpenses
                    .filter(e => e.category === budget.category && e.subcategory === budget.subcategory)
                    .reduce((sum, e) => sum + e.amount, 0);
                return { ...budget, actualSpend };
            });

            if (activeSubscriptions.length > 0) {
                reportData.push({
                    category: 'Subscriptions',
                    subcategory: 'Recurring',
                    amount: totalSubscriptionCost, 
                    actualSpend: totalSubscriptionCost
                });
            }

            if (reportData.length === 0) {
                budgetActualReportEl.innerHTML = '<p>No budgets or subscriptions to report.</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'min-w-full bg-white';
                table.innerHTML = `
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-2 px-4 text-left">Category</th>
                            <th class="py-2 px-4 text-left">Subcategory</th>
                            <th class="py-2 px-4 text-right">Budgeted</th>
                            <th class="py-2 px-4 text-right">Actual</th>
                            <th class="py-2 px-4 text-right">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reportData.map(item => {
                            const difference = item.amount - item.actualSpend;
                            const diffClass = difference >= 0 ? 'text-green-600' : 'text-red-600';
                            return `
                                <tr>
                                    <td class="border px-4 py-2">${item.category}</td>
                                    <td class="border px-4 py-2">${item.subcategory}</td>
                                    <td class="border px-4 py-2 text-right">${formatCurrency(item.amount)}</td>
                                    <td class="border px-4 py-2 text-right">${formatCurrency(item.actualSpend)}</td>
                                    <td class="border px-4 py-2 text-right font-medium ${diffClass}">${formatCurrency(difference)}</td>
                                </tr>
                            `;
                        }).join('')}
                         <tr class="font-bold bg-gray-100">
                            <td class="border px-4 py-2" colspan="2">Total</td>
                            <td class="border px-4 py-2 text-right">${formatCurrency(totalBudgeted)}</td>
                            <td class="border px-4 py-2 text-right">${formatCurrency(monthlyExpenses.reduce((s,e) => s + e.amount, 0) + totalSubscriptionCost)}</td>
                            <td class="border px-4 py-2 text-right ${totalBudgeted - (monthlyExpenses.reduce((s,e) => s + e.amount, 0) + totalSubscriptionCost) >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalBudgeted - (monthlyExpenses.reduce((s,e) => s + e.amount, 0) + totalSubscriptionCost))}</td>
                        </tr>
                    </tbody>
                `;
                budgetActualReportEl.appendChild(table);
            }

            // --- 3. Spend by Category Report ---
            const categorySpend = monthlyExpenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});
            if (totalSubscriptionCost > 0) {
                categorySpend['Subscriptions'] = totalSubscriptionCost;
            }
            
            categorySpendReportEl.innerHTML = '';
            if (Object.keys(categorySpend).length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside';
                for (const category in categorySpend) {
                    const li = document.createElement('li');
                    li.textContent = `${category}: ${formatCurrency(categorySpend[category])}`;
                    ul.appendChild(li);
                }
                categorySpendReportEl.appendChild(ul);
            } else {
                categorySpendReportEl.innerHTML = '<p>No expenses recorded for this month.</p>';
            }

            // --- 4. Spend by Payment Type Report ---
            const paymentTypeSpend = monthlyExpenses.reduce((acc, expense) => {
                acc[expense.paymentType] = (acc[expense.paymentType] || 0) + expense.amount;
                return acc;
            }, {});

            paymentTypeSpendReportEl.innerHTML = '';
             if (Object.keys(paymentTypeSpend).length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside';
                for (const type in paymentTypeSpend) {
                    const li = document.createElement('li');
                    li.textContent = `${type}: ${formatCurrency(paymentTypeSpend[type])}`;
                    ul.appendChild(li);
                }
                paymentTypeSpendReportEl.appendChild(ul);
            } else {
                paymentTypeSpendReportEl.innerHTML = '<p>No expenses recorded for this month.</p>';
            }
            
            // --- 5. Points Report ---
            const pointsByCard = {};
            monthlyExpenses.forEach(expense => {
                const rule = allPointsRules.find(r => r.category === expense.category && r.subcategory === expense.subcategory && r.card === expense.paymentType);
                if (rule) {
                    const points = Math.floor(expense.amount * rule.multiplier);
                    pointsByCard[rule.card] = (pointsByCard[rule.card] || 0) + points;
                }
            });
             pointsReportEl.innerHTML = '';
             if (Object.keys(pointsByCard).length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside';
                for (const card in pointsByCard) {
                    const li = document.createElement('li');
                    li.textContent = `${card}: ${pointsByCard[card].toLocaleString()} points`;
                    ul.appendChild(li);
                }
                pointsReportEl.appendChild(ul);
            } else {
                pointsReportEl.innerHTML = '<p>No points earned this month.</p>';
            }
        }
        
        // --- EVENT LISTENERS for Category/Subcategory dropdowns ---
        document.getElementById('expenseCategory').addEventListener('change', (e) => handleCategoryChange(e.target.value, 'expenseSubcategory'));
        document.getElementById('budgetCategory').addEventListener('change', (e) => handleCategoryChange(e.target.value, 'budgetSubcategory'));
        document.getElementById('pointsCategory').addEventListener('change', (e) => handleCategoryChange(e.target.value, 'pointsSubcategory'));

        async function handleCategoryChange(categoryName, subcategorySelectId) {
            const categories = await getAllObjects('categories');
            const selectedCategory = categories.find(c => c.name === categoryName);
            const subcategorySelect = document.getElementById(subcategorySelectId);
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            if (selectedCategory) {
                selectedCategory.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        }
        
        async function handleCategoryChangeForEdit(categoryName, subcategoryNameToSelect, subcategorySelectId = 'expenseSubcategory') {
            await handleCategoryChange(categoryName, subcategorySelectId);
            document.getElementById(subcategorySelectId).value = subcategoryNameToSelect;
        }

        // --- CALENDAR LOGIC ---
        async function renderExpenseCalendar(year, month) {
            const calendarHeader = document.getElementById('calendarHeader');
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarHeader || !calendarGrid) return;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();

            calendarHeader.textContent = `${firstDay.toLocaleString('default', { month: 'long' })} ${year}`;

            const allExpenses = await getAllObjects('expenses');
            const allSubscriptions = await getAllObjects('subscriptions');
            const dailyItems = {};
            const monthString = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            
            allExpenses
                .filter(e => e.date.startsWith(monthString))
                .forEach(e => {
                    const day = new Date(e.date + 'T00:00:00').getDate();
                    if (!dailyItems[day]) {
                        dailyItems[day] = [];
                    }
                    dailyItems[day].push(e);
                });

            allSubscriptions
                .filter(s => s.status === 'active')
                .forEach(s => {
                    const subDay = new Date(s.startDate + 'T00:00:00').getDate();
                    if (subDay <= daysInMonth) {
                         if (!dailyItems[subDay]) {
                            dailyItems[subDay] = [];
                        }
                        dailyItems[subDay].push({ payee: s.name, amount: s.amount, isSubscription: true });
                    }
                });

            calendarGrid.innerHTML = '';
            for (let i = 0; i < startingDay; i++) {
                calendarGrid.innerHTML += `<div class="border p-2 bg-gray-50 rounded-md"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const itemsForDay = dailyItems[day] || [];
                let itemsHTML = '';
                if (itemsForDay.length > 0) {
                    itemsHTML = '<ul class="text-xs text-left mt-1 space-y-0.5 overflow-y-auto max-h-16">';
                    itemsForDay.forEach(item => {
                        const colorClass = item.isSubscription ? 'text-blue-600' : 'text-red-600';
                        itemsHTML += `<li class="truncate ${colorClass}"><span class="font-semibold">${formatCurrency(item.amount)}</span> ${item.payee}</li>`;
                    });
                    itemsHTML += '</ul>';
                }

                let cellHTML = `<div class="border p-2 h-28 flex flex-col bg-white rounded-md">
                                  <span class="font-semibold">${day}</span>
                                  ${itemsHTML}
                              </div>`;
                calendarGrid.innerHTML += cellHTML;
            }
        }

        function setupCalendarNav() {
            document.getElementById('prevMonth').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderExpenseCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderExpenseCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
        }

        // --- MODAL & NOTIFICATION LOGIC ---
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');

            messageEl.textContent = message;
            notification.className = notification.className.replace(/bg-gray-800|bg-red-600/g, '');
            notification.classList.add(isError ? 'bg-red-600' : 'bg-gray-800');
            notification.classList.remove('translate-y-20', 'opacity-0');

            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function showConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;

            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');

            const confirmHandler = () => {
                onConfirm();
                closeModal();
            };

            const cancelHandler = () => closeModal();
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', confirmHandler, { once: true });

            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newCancelBtn.addEventListener('click', cancelHandler, { once: true });

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('confirmationModal').classList.remove('active');
        }

        // --- ITEMIZATION LOGIC ---
        async function openItemizationModal(expenseId) {
            const modal = document.getElementById('itemizationModal');
            document.getElementById('itemizationExpenseId').value = expenseId;
            
            const expense = await getObject('expenses', expenseId);
            if (!expense) return;

            document.getElementById('itemizationModalTitle').textContent = `Itemize: ${expense.payee}`;
            document.getElementById('itemizationTotal').textContent = formatCurrency(expense.amount);
            
            await renderItemizedList(expense);

            modal.classList.add('active');
        }

        async function renderItemizedList(expense) {
            const listEl = document.getElementById('itemizedList');
            listEl.innerHTML = '';
            let itemizedTotal = 0;

            if (expense.items && expense.items.length > 0) {
                expense.items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2';
                    li.innerHTML = `
                        <span>${item.name}</span>
                        <div>
                            <span class="font-medium mr-4">${formatCurrency(item.amount)}</span>
                            <button onclick="deleteItemizedEntry(${expense.id}, ${index})" class="text-red-500 hover:underline">x</button>
                        </div>
                    `;
                    listEl.appendChild(li);
                    itemizedTotal += item.amount;
                });
            }
            
            const remaining = expense.amount - itemizedTotal;
            const remainingEl = document.getElementById('itemizationRemaining');
            remainingEl.textContent = formatCurrency(remaining);
            remainingEl.className = 'font-bold text-lg ';
            remainingEl.classList.add(remaining < 0 ? 'text-red-500' : 'text-green-600');
        }

        document.getElementById('itemizationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const expenseId = parseInt(document.getElementById('itemizationExpenseId').value);
            const itemName = document.getElementById('itemName').value;
            const itemAmount = parseFloat(document.getElementById('itemAmount').value);

            const expense = await getObject('expenses', expenseId);
            if (!expense) return;

            if (!expense.items) {
                expense.items = [];
            }
            expense.items.push({ name: itemName, amount: itemAmount });

            await updateObject('expenses', expense);
            await renderItemizedList(expense);
            await loadExpenses(); // To update the "View Items" button
            e.target.reset();
        });

        async function deleteItemizedEntry(expenseId, itemIndex) {
            const expense = await getObject('expenses', expenseId);
            if (!expense || !expense.items) return;

            expense.items.splice(itemIndex, 1);
            await updateObject('expenses', expense);
            await renderItemizedList(expense);
            await loadExpenses();
        }

        document.getElementById('itemizationDone').addEventListener('click', () => {
            document.getElementById('itemizationModal').classList.remove('active');
        });


        // --- DATA MANAGEMENT ---
        async function exportData() {
            try {
                const stores = ['income', 'expenses', 'subscriptions', 'budgets', 'paymentMethods', 'categories', 'people', 'groceryItems', 'creditCardPoints'];
                const exportObject = {};

                for (const storeName of stores) {
                    exportObject[storeName] = await getAllObjects(storeName);
                }

                const jsonString = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `home-budget-backup-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Data exported successfully!');
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('Failed to export data.', true);
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const onConfirmImport = () => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        const stores = ['income', 'expenses', 'subscriptions', 'budgets', 'paymentMethods', 'categories', 'people', 'groceryItems', 'creditCardPoints'];

                        for (const storeName of stores) {
                            if (data.hasOwnProperty(storeName) && !Array.isArray(data[storeName])) {
                                throw new Error(`Invalid or missing data for: ${storeName}`);
                            }
                        }

                        const transaction = db.transaction(stores, 'readwrite');
                        for (const storeName of stores) {
                            if(data.hasOwnProperty(storeName)) {
                                await new Promise((resolve, reject) => {
                                    const request = transaction.objectStore(storeName).clear();
                                    request.onsuccess = resolve;
                                    request.onerror = reject;
                                });
                            }
                        }
                        
                        const importTransaction = db.transaction(stores, 'readwrite');
                        for (const storeName of stores) {
                             if(data.hasOwnProperty(storeName)) {
                                const store = importTransaction.objectStore(storeName);
                                for (const item of data[storeName]) {
                                    if (item.hasOwnProperty('id')) delete item.id;
                                    store.add(item);
                                }
                            }
                        }

                        await new Promise((resolve, reject) => {
                            importTransaction.oncomplete = resolve;
                            importTransaction.onerror = reject;
                        });
                        
                        await reloadAllData();
                        showNotification('Data imported successfully!');
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showNotification(`Import failed: ${error.message}`, true);
                    }
                };
                reader.readAsText(file);
            };
            
            showConfirmation('Import JSON Data', 'This will overwrite all current data. Are you sure?', onConfirmImport);
            event.target.value = null;
        }

        function importCsvData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const onConfirmImport = () => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').slice(1); // Skip header
                        for(const line of lines) {
                            if (line.trim() === '') continue;
                            const [date, payee, category, subcategory, paymentType, amount, notes] = line.split(',');
                            const expenseData = {
                                date: date.trim(),
                                payee: payee.trim(),
                                category: category.trim(),
                                subcategory: subcategory.trim(),
                                paymentType: paymentType.trim(),
                                amount: parseFloat(amount.trim()),
                                notes: notes ? notes.trim() : '',
                                items: []
                            };
                            await addObject('expenses', expenseData);
                        }
                        await reloadAllData();
                        showNotification('CSV data imported successfully!');
                    } catch (error) {
                         console.error('Error importing CSV:', error);
                        showNotification(`CSV Import failed: ${error.message}`, true);
                    }
                };
                reader.readAsText(file);
            };
            
            showConfirmation('Import CSV Expenses', 'This will add new expenses from the CSV. Required format: Date,Payee,Category,Subcategory,Payment Type,Amount,Notes', onConfirmImport);
            event.target.value = null;
        }

        // --- GROCERY ITEMS LOGIC ---
        async function loadGroceryItems() {
            const items = await getAllObjects('groceryItems');
            const listEl = document.getElementById('groceryItemList');
            const dataListEl = document.getElementById('groceryDataList');
            const selectEl = document.getElementById('groceryItemSelect');

            listEl.innerHTML = '';
            dataListEl.innerHTML = '';
            selectEl.innerHTML = '<option value="">Select an item</option>';

            items.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                // Populate settings list
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 border-b';
                li.innerHTML = `
                    <span>${item.name}</span>
                    <button onclick="deleteGroceryItem(${item.id})" class="text-red-500 hover:underline">Delete</button>
                `;
                listEl.appendChild(li);

                // Populate datalist for autocomplete
                const option = document.createElement('option');
                option.value = item.name;
                dataListEl.appendChild(option);

                // Populate report dropdown
                const selectOption = document.createElement('option');
                selectOption.value = item.name;
                selectOption.textContent = item.name;
                selectEl.appendChild(selectOption);
            });
        }

        async function deleteGroceryItem(id) {
            showConfirmation('Delete Grocery Item', 'Are you sure?', async () => {
                await deleteObject('groceryItems', id);
                loadGroceryItems();
                showNotification('Grocery item deleted.');
            });
        }

        async function generateYearlyReports() {
            const year = document.getElementById('reportYear').value;
            if (!year) return;

            const allExpenses = await getAllObjects('expenses');
            const yearlyExpenses = allExpenses.filter(e => e.date.startsWith(year));

            // --- Yearly Spend by Category ---
            const categorySpend = yearlyExpenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});
            const categoryEl = document.getElementById('yearlyCategorySpendReport');
            categoryEl.innerHTML = '';
            if (Object.keys(categorySpend).length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside';
                for (const category in categorySpend) {
                    const li = document.createElement('li');
                    li.textContent = `${category}: ${formatCurrency(categorySpend[category])}`;
                    ul.appendChild(li);
                }
                categoryEl.appendChild(ul);
            } else {
                categoryEl.innerHTML = '<p>No expenses recorded for this year.</p>';
            }

            // --- Yearly Spend by Subcategory ---
            const subcategorySpend = yearlyExpenses.reduce((acc, expense) => {
                const key = `${expense.category} / ${expense.subcategory}`;
                acc[key] = (acc[key] || 0) + expense.amount;
                return acc;
            }, {});
            const subcategoryEl = document.getElementById('yearlySubcategorySpendReport');
            subcategoryEl.innerHTML = '';
            if (Object.keys(subcategorySpend).length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside';
                for (const sub in subcategorySpend) {
                    const li = document.createElement('li');
                    li.textContent = `${sub}: ${formatCurrency(subcategorySpend[sub])}`;
                    ul.appendChild(li);
                }
                subcategoryEl.appendChild(ul);
            } else {
                subcategoryEl.innerHTML = '<p>No expenses recorded for this year.</p>';
            }

            // --- Grocery Price Tracker ---
            const selectedItem = document.getElementById('groceryItemSelect').value;
            const priceTrackerEl = document.getElementById('groceryPriceTrackerReport');
            priceTrackerEl.innerHTML = '';
            if (selectedItem) {
                const priceHistory = [];
                yearlyExpenses.forEach(expense => {
                    if (expense.items && expense.items.length > 0) {
                        expense.items.forEach(item => {
                            if (item.name === selectedItem) {
                                priceHistory.push({ date: expense.date, amount: item.amount, payee: expense.payee });
                            }
                        });
                    }
                });

                if (priceHistory.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'min-w-full bg-white';
                    table.innerHTML = `
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-4 text-left">Date</th>
                                <th class="py-2 px-4 text-left">Store</th>
                                <th class="py-2 px-4 text-right">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${priceHistory.sort((a,b) => new Date(a.date) - new Date(b.date)).map(item => `
                                <tr>
                                    <td class="border px-4 py-2">${item.date}</td>
                                    <td class="border px-4 py-2">${item.payee}</td>
                                    <td class="border px-4 py-2 text-right">${formatCurrency(item.amount)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    priceTrackerEl.appendChild(table);
                } else {
                    priceTrackerEl.innerHTML = '<p>No purchases of this item found for the selected year.</p>';
                }
            } else {
                priceTrackerEl.innerHTML = '<p>Select an item to see its price history.</p>';
            }
        }
        
        // --- POINTS LOGIC ---
        async function loadPoints() {
            const points = await getAllObjects('creditCardPoints');
            const list = document.getElementById('pointsList');
            list.innerHTML = '';
            points.forEach(point => {
                const row = list.insertRow();
                row.innerHTML = `
                    <td class="border px-4 py-2">${point.category}</td>
                    <td class="border px-4 py-2">${point.subcategory}</td>
                    <td class="border px-4 py-2">${point.card}</td>
                    <td class="border px-4 py-2 text-right">${point.multiplier}x</td>
                    <td class="border px-4 py-2 text-center">
                        <button onclick="editPoint(${point.id})" class="text-blue-500 hover:underline">Edit</button>
                        <button onclick="deletePoint(${point.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                    </td>
                `;
            });
        }

        async function editPoint(id) {
            const point = await getObject('creditCardPoints', id);
            document.getElementById('pointsId').value = point.id;
            document.getElementById('pointsCategory').value = point.category;
            await handleCategoryChangeForEdit(point.category, point.subcategory, 'pointsSubcategory');
            document.getElementById('pointsCard').value = point.card;
            document.getElementById('pointsMultiplier').value = point.multiplier;
        }

        async function deletePoint(id) {
            showConfirmation('Delete Point Rule', 'Are you sure?', async () => {
                await deleteObject('creditCardPoints', id);
                loadPoints();
                showNotification('Point rule deleted.');
            });
        }
        
        // --- CATEGORY EDITING ---
        function startEditCategory(button, categoryId) {
            const span = button.closest('span').querySelector('.category-name');
            const currentName = span.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'p-1 border rounded-md text-sm';
            input.onkeydown = (e) => {
                if (e.key === 'Enter') saveCategory(categoryId, input);
                if (e.key === 'Escape') cancelEditCategory(categoryId, currentName, input);
            };

            span.replaceWith(input);
            input.focus();
            input.select();
        }

        async function saveCategory(categoryId, input) {
            const newName = input.value;
            const category = await getObject('categories', categoryId);
            if (category) {
                category.name = newName;
                await updateObject('categories', category);
                await reloadAllData();
            }
        }

        function cancelEditCategory(categoryId, oldName, input) {
            loadCategories();
        }

        function startEditSubcategory(button, categoryId, oldName) {
            const span = button.closest('li').querySelector('.subcategory-name');
            const currentName = oldName;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'p-1 border rounded-md text-sm';
             input.onkeydown = (e) => {
                if (e.key === 'Enter') saveSubcategory(categoryId, oldName, input);
                if (e.key === 'Escape') cancelEditCategory();
            };

            span.innerHTML = '- ';
            span.appendChild(input);
            input.focus();
            input.select();
        }
        
        async function saveSubcategory(categoryId, oldName, input) {
            const newName = input.value;
            const category = await getObject('categories', categoryId);
            if (category) {
                const subIndex = category.subcategories.indexOf(oldName);
                if (subIndex > -1) {
                    category.subcategories[subIndex] = newName;
                    await updateObject('categories', category);
                    await reloadAllData();
                }
            }
        }
        
        // --- TABLE SORTING ---
        function setupTableSorting() {
            document.querySelectorAll('th[data-sort]').forEach(headerCell => {
                headerCell.addEventListener('click', () => {
                    const tableElement = headerCell.closest('table');
                    const tbody = tableElement.querySelector('tbody');
                    const columnKey = headerCell.dataset.sort;
                    const isAsc = !headerCell.classList.contains('sort-asc');

                    document.querySelectorAll('th[data-sort]').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                    });
                    headerCell.classList.toggle('sort-asc', isAsc);
                    headerCell.classList.toggle('sort-desc', !isAsc);

                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const headerIndex = Array.from(headerCell.parentNode.children).indexOf(headerCell);

                    rows.sort((a, b) => {
                        let valA = a.children[headerIndex].textContent.trim();
                        let valB = b.children[headerIndex].textContent.trim();
                        
                        // Handle currency
                        if (valA.startsWith('$')) {
                            valA = parseFloat(valA.replace(/[$,]/g, ''));
                            valB = parseFloat(valB.replace(/[$,]/g, ''));
                        } else if (!isNaN(Date.parse(valA)) && !isNaN(Date.parse(valB))) { // Handle dates
                            valA = new Date(valA);
                            valB = new Date(valB);
                        }

                        if (!isNaN(valA) && !isNaN(valB) && typeof valA !== 'object') {
                             return isAsc ? valA - valB : valB - valA;
                        }

                        if (valA instanceof Date && valB instanceof Date) {
                             return isAsc ? valA - valB : valB - valA;
                        }

                        return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    });

                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }


        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(Math.round(amount));
        }

    </script>
</body>
</html>
